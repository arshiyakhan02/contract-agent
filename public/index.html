<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Contract Assistant v3 (Debug)</title>

    <style>
        body {
            font-family: sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f0f0;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: 1px solid #ccc;
        }

        input,
        button {
            padding: 10px;
            margin: 5px 0;
            width: 100%;
            box-sizing: border-box;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        button:hover {
            background-color: #0056b3;
        }

        .success {
            color: green;
            font-weight: bold;
        }

        .error {
            color: red;
            font-weight: bold;
        }

        .loader {
    margin: 12px auto 0;
    width: 32px;
    height: 32px;
    border: 4px solid #d9f2f5;
    border-top: 4px solid #4f9da6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

    </style>
</head>

<body>
    <h1>Contract Assistant</h1>
    <p>Please follow the steps below.</p>

    <div class="card">
        <h2>1. Upload Template</h2>
        <input type="file" id="templateFile" accept=".pdf" onchange="uploadTemplate()" />
        <p id="uploadStatus">No file selected.</p>
    </div>

    <div class="card">
        <h2>2. Create Contract</h2>
        <input type="text" id="pName" placeholder="Your Name" />
        <input type="text" id="pEmail" placeholder="Your Email" />
        <input type="text" id="tName" value="standard-template.pdf" readonly style="background:#eee;" />
        <!-- <button onclick="initContract()">Create Contract</button> -->
        <button onclick="initContract()"
    style="background:#4f9da6;color:#fff;border-radius:20px;">
    Create Contract
</button>
<div id="contractLoader" class="loader" style="display:none;"></div>


    </div>

    <div class="card" id="workspace" style="display:none; border:2px solid #007bff;">
        <h2>3. Contract Workspace</h2>

        <p><strong>Contract ID:</strong> <span id="contractId"></span></p>
        <p><strong>Status:</strong> <span id="contractStatus">DRAFT</span></p>

        <h3>AI Contract Chat</h3>

        <div id="chatHistory"
            style="height:320px; overflow-y:auto; padding:12px; background:#eef4f9; border-radius:10px; border:1px solid #c8d6e5;">
            <div style="color:#666;font-style:italic;">
                Contract created successfully. You can now chat with the AI about this document.
            </div>
        </div>

        <div style="display:flex; padding:10px; background:white; border-top:1px solid #eee;">
            <input id="chatInput" placeholder="Type your message..."
                style="flex:1;border-radius:20px;border:1px solid #4f9da6;padding:10px 14px;"
                onkeypress="if(event.key==='Enter') sendChatMessage()" />
            <button onclick="sendChatMessage()"
                style="width:80px;border-radius:20px;background:#4f9da6;color:#fff;">
                Send
            </button>
        </div>

        <h3>Sign</h3>
        <button onclick="sendForSignature()" style="background:#4f9da6;color:#fff;border-radius:20px;">
            Generate Signing Link
        </button>
        <div id="signLoader" class="loader" style="display:none;"></div>


        <div id="signResult" style="margin-top:10px;"></div>
    </div>

    <script>
        let currentId = null;

        async function uploadTemplate() {
            const file = document.getElementById('templateFile').files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            const res = await fetch('/api/v1/storage/upload', { method: 'POST', body: formData });
            const data = await res.json();

            if (data.success) {
                document.getElementById('uploadStatus').innerHTML =
                    `<span class="success">Uploaded: ${data.data.filename}</span>`;
                document.getElementById('tName').value = data.data.filename;
            }
        }

        async function initContract() {

        // üîπ SHOW loader (ADDED)
            document.getElementById('contractLoader').style.display = 'block';
        const patientData = {
            name: document.getElementById('pName').value,
            email: document.getElementById('pEmail').value
        };

            const templateName = document.getElementById('tName').value;

            const res = await fetch('/api/v1/webhooks/init-contract', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ patientData, templateName })
            });

            const data = await res.json();

            if (data.success) {
                // üîπ HIDE loader (ADDED)
            document.getElementById('contractLoader').style.display = 'none';

                currentId = data.data.contractId;
                document.getElementById('workspace').style.display = 'block';
                document.getElementById('contractId').innerText = currentId;
                document.getElementById('contractStatus').innerText = data.data.status;
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const question = input.value.trim();
            const q = question.toLowerCase();

// üîπ Help: How to fill the form
if (
    q.includes('how to fill') ||
    q.includes('fill this form') ||
    q.includes('fill the form') ||
    q.includes('form kaise') ||
    q.includes('form kese') ||
    q.includes('process of filling') ||
    q.includes('steps to fill')
) {
    addChatMessage('user', question);

    const reply = `Here is the complete process to fill the form:

Upload the Document  
First, upload the PDF you have. This can be a prescription, payment related document, or any other required file.

2. Enter Your Details  
After uploading the document, fill in your Name and Email Address in the form fields.

3. Create the Contract  
Click on the ‚ÄúCreate Contract‚Äù button to generate the contract using the uploaded PDF and details.

4. Use AI Contract Chat  
Once the contract is created, the AI chatbot will open. You can ask questions related to the uploaded PDF or the contract.

5. Generate Signing Link  
Click on ‚ÄúGenerate Signing Link‚Äù to create a secure link for signing the document.

6. Sign via DocuSign  
The document will open in DocuSign, where you can digitally sign it and download the signed PDF.

This completes the entire contract and signing process.`;

    addChatMessage('ai', reply);
    input.value = '';
    document.getElementById('thinking-bubble')?.remove();
    return; // ‚õî backend call skipped
}
            if (!question) return;

            addChatMessage('user', question);
            input.value = '';

            addChatMessage('thinking', 'Thinking...');

            const res = await fetch(`/api/v1/contracts/${currentId}/chat`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question })
            });

            const data = await res.json();
            document.getElementById('thinking-bubble')?.remove();

            if (data.success) addChatMessage('ai', data.data.answer);
            else addChatMessage('error', 'Something went wrong');
        }

        function addChatMessage(role, text) {
            const history = document.getElementById('chatHistory');
            const div = document.createElement('div');

            div.style.marginBottom = '10px';
            div.style.padding = '8px 12px';
            div.style.borderRadius = '15px';
            div.style.maxWidth = '80%';

            if (role === 'user') {
                div.style.marginLeft = 'auto';
                div.style.background = '#4f9da6';
                div.style.color = '#fff';
                div.innerText = text;
            }
            else if (role === 'thinking') {
                div.id = 'thinking-bubble';
                div.style.margin = '0 auto';
                div.style.background = '#d9f2f5';
                div.innerText = 'Thinking...';
            }
            else if (role === 'error') {
                div.style.background = '#f8d7da';
                div.innerText = text;
            }
            else {
                div.style.background = '#fff';
                div.style.border = '1px solid #c8d6e5';

                const cleanText = text
                    .replace(/[*#‚Ä¢-]+/g, '')
                    .replace(/\s+/g, ' ')
                    .trim();

                let points = [];

                if (cleanText.length > 120) {
                    points = cleanText
                        .split('.')
                        .map(p => p.trim())
                        .filter(p => p.length > 5);
                }

                if (points.length === 0) {
                    div.innerText = cleanText;
                } else {
                    let html = `<strong>AI:</strong><ul>`;
                    points.forEach(p => html += `<li>${p}.</li>`);
                    html += `</ul>`;
                    div.innerHTML = html;
                }
            }

            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
        }

        async function sendForSignature() {
            // üîµ show loader
    document.getElementById('signLoader').style.display = 'block';
    const res = await fetch(`/api/v1/contracts/${currentId}/send`, { method: 'POST' });
    const data = await res.json();
    // üîµ hide loader
    document.getElementById('signLoader').style.display = 'none';


    if (data.success) {
        document.getElementById('signResult').innerHTML = `
            <a href="${data.signingUrl}" target="_blank"
               style="
                 display:block;
                 width:100%;
                 background:#4f9da6;
                 color:#fff;
                 padding:14px;
                 text-align:center;
                 font-weight:bold;
                 text-decoration:none;
                 border-radius:20px;
                 margin-top:12px;
                 box-sizing:border-box;
               ">
               ‚úçÔ∏è Click here to sign
            </a>
        `;
    }
}

    </script>
</body>
</html>
