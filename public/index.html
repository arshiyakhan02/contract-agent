<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Contract Assistant v3 (Debug)</title>

    <style>
        body {
            font-family: sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f0f0;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: 1px solid #ccc;
        }

        input,
        button {
            padding: 10px;
            margin: 5px 0;
            width: 100%;
            box-sizing: border-box;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        button:hover {
            background-color: #0056b3;
        }

        .success {
            color: green;
            font-weight: bold;
        }

        .error {
            color: red;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h1>Contract Assistant</h1>
    <p>Please follow the steps below.</p>

    <div class="card">
        <h2>1. Upload Template</h2>
        <input type="file" id="templateFile" accept=".pdf" onchange="uploadTemplate()" />
        <p id="uploadStatus">No file selected.</p>
    </div>

    <div class="card">
        <h2>2. Create Contract</h2>
        <input type="text" id="pName" placeholder="Your Name" />
        <input type="text" id="pEmail" placeholder="Your Email" />
        <input type="text" id="tName" placeholder="Template Name" value="standard-template.pdf" readonly
            style="background: #eee;" />
        <button onclick="initContract()">Create Contract</button>
        <p id="createStatus"></p>
    </div>

    <div class="card" id="workspace" style="display: none; border: 2px solid #007bff;">
        <h2>3. Contract Workspace</h2>

        <p><strong>Contract ID:</strong> <span id="contractId"></span></p>
        <p><strong>Status:</strong> <span id="contractStatus">DRAFT</span></p>

        <h3>AI Contract Chat</h3>

        <div id="chatContainer" style="border: 1px solid #ccc; border-radius: 5px; margin-bottom: 20px;">
            <!-- <div id="chatHistory" style="height: 300px; overflow-y: auto; padding: 10px; background: #f9f9f9;"> -->
                <div id="chatHistory" style="height: 320px; overflow-y: auto; padding: 12px; background: #eef4f9; border-radius: 10px; border: 1px solid #c8d6e5;">

                <div style="color: #666; font-style: italic;">
                    Contract created successfully. You can now chat with the AI about this document.
                </div>
            </div>

            <div style="display: flex; padding: 10px; border-top: 1px solid #eee; background: white;">
                <input type="text" id="chatInput" placeholder="Type your message..."
                    style= "flex:1; margin-right:10px; border-radius:20px; border:1px solid #4f9da6; padding:10px 14px; font-size:15px;"
    onkeypress="if(event.key==='Enter') sendChatMessage()" />
                <button onclick="sendChatMessage()" style="
    width:80px;
    margin:0;
    border-radius:20px;
    background:#4f9da6;
    color:#fff;
    font-weight:bold;
">
    Send
</button>
            </div>
        </div>

        <h3>Sign</h3>
        <button onclick="sendForSignature()" style="
    background:#4f9da6;
    color:#fff;
    border-radius:20px;
    font-weight:bold;
">
    Generate Signing Link
</button>

        <div id="signResult" style="margin-top: 10px;"></div>
    </div>

    <script>
        let currentId = null;

        function log(msg, type = 'info') {
            console.log(`[${new Date().toLocaleTimeString()}] ${msg}`);
        }

        async function uploadTemplate() {
            const fileInput = document.getElementById('templateFile');
            if (!fileInput.files[0]) return;

            const file = fileInput.files[0];
            log(`Starting upload for: ${file.name}`);
            document.getElementById('uploadStatus').innerText = 'Uploading...';

            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch('/api/v1/storage/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await res.json();

                if (data.success) {
                    log(`Upload success: ${data.data.filename}`);
                    document.getElementById('uploadStatus').innerHTML =
                        `<span class="success">✅ Uploaded: ${data.data.filename}</span>`;
                    document.getElementById('tName').value = data.data.filename;
                } else {
                    throw new Error(data.message);
                }
            } catch (e) {
                log(`Upload failed: ${e.message}`, 'error');
                document.getElementById('uploadStatus').innerHTML =
                    `<span class="error">❌ Error: ${e.message}</span>`;
                alert('Upload Error: ' + e.message);
            }
        }

        async function initContract() {
            const patientData = {
                name: document.getElementById('pName').value,
                email: document.getElementById('pEmail').value,
                price: "150.00"
            };

            const templateName = document.getElementById('tName').value;
            log(`Creating contract with template: ${templateName}`);

            try {
                const res = await fetch('/api/v1/webhooks/init-contract', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ patientData, templateName })
                });

                const data = await res.json();

                if (data.success) {
                    log(`Contract created: ${data.data.contractId}`);
                    currentId = data.data.contractId;

                    document.getElementById('workspace').style.display = 'block';
                    document.getElementById('contractId').innerText = currentId;
                    document.getElementById('contractStatus').innerText = data.data.status;
                } else {
                    throw new Error(data.message);
                }
            } catch (e) {
                log(`Creation failed: ${e.message}`, 'error');
                alert('Creation Error: ' + e.message);
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const question = input.value.trim();

            if (!question || !currentId) return;

            input.value = '';
            addChatMessage('user', question);

            try {
                const thinkingId = addChatMessage('thinking', 'Thinking...');

                const res = await fetch(`/api/v1/contracts/${currentId}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question })
                });

                const data = await res.json();

                if (thinkingId) {
                    const thinkingEl = document.getElementById(thinkingId);
                    if (thinkingEl && thinkingEl.parentNode) {
                        thinkingEl.parentNode.removeChild(thinkingEl);
                    }
                }

                if (data.success) {
                    addChatMessage('ai', data.data.answer);
                } else {
                    addChatMessage('error', 'Error: ' + data.message);
                }
            } catch (e) {
                addChatMessage('error', 'Network Error: ' + e.message);
            }
        }

        function addChatMessage(role, text) {
            const history = document.getElementById('chatHistory');
            const div = document.createElement('div');
            const id = 'msg-' + Date.now();

            div.id = id;
            div.style.marginBottom = '10px';
            div.style.padding = '8px 12px';
            div.style.borderRadius = '15px';
            div.style.maxWidth = '80%';

            if (role === 'user') {
                div.style.marginLeft = 'auto';
                // div.style.background = '#007bff';
                div.style.background = '#4f9da6';
                // div.style.color = 'white';
                div.style.color = '#fff';
                div.style.boxShadow = '0 2px 5px rgba(0,0,0,0.12)';
                div.innerText = text;
            } else if (role === 'system') {
                div.style.margin = '0 auto';
                // div.style.background = '#e2e3e5';
                div.style.background = '#d9f2f5';
                // div.style.color = '#383d41';
                div.style.color = '#2b3d51';
                div.style.borderRadius = '20px';
                div.style.fontWeight = '500';
                div.style.textAlign = 'center';
                div.style.fontSize = '0.9em';
                div.innerText = text;
            } else if (role === 'error') {
                div.style.background = '#f8d7da';
                div.style.color = '#721c24';
                div.innerText = text;
            } else {
                div.style.marginRight = 'auto';
                // div.style.background = '#e9ecef';
                div.style.background = '#ffffff';
                // div.style.color = 'black';
                div.style.color = '#2b3d51';
                div.style.border = '1px solid #c8d6e5';
                div.style.boxShadow = '0 1px 4px rgba(0,0,0,0.08)';

                const points = text
                    .split(/\n|•|- /)
                    .map(p => p.trim())
                    .filter(p => p.length > 0);

                let html = `<strong>AI:</strong>
                    <ul style="margin-top:6px;padding-left:20px;">`;

                points.forEach(p => {
                    html += `<li>${p}</li>`;
                });

                html += `</ul>`;
                div.innerHTML = html;
            }

            history.appendChild(div);
            history.scrollTop = history.scrollHeight;

            return id;
        }

        async function sendForSignature() {
            if (!currentId) return alert('No contract created yet');

            const btn = document.querySelector('button[onclick="sendForSignature()"]');

            if (btn) {
    btn.disabled = true;
    btn.innerText = 'Generating link...';
    btn.style.background = '#4f9da6';
    btn.style.color = '#fff';
    btn.style.borderRadius = '20px';
}

            log(`Requesting signature for ${currentId}...`);

            try {
                const res = await fetch(`/api/v1/contracts/${currentId}/send`, {
                    method: 'POST'
                });

                const data = await res.json();

                if (data.success) {
                    log(`Signature request success. Envelope: ${data.envelopeId}`);
                    document.getElementById('contractStatus').innerText = 'SENT_FOR_SIGNATURE';

                    if (data.signingUrl) {
                        html += `
                            <a href="${data.signingUrl}" target="_blank"
                               style="
         display:block;
         background:#4f9da6;
         color:#fff;
         padding:15px;
         text-align:center;
         text-decoration:none;
         font-weight:bold;
         border-radius:20px;
       ">
       ✍️ CLICK HERE TO SIGN DEMO CONTRACT
                            </a>`;
                    } else {
                        throw new Error('Signing URL not returned');
                    }

                    document.getElementById('signResult').innerHTML = html;
                } else {
                    throw new Error(data.message || 'Failed to generate signing link');
                }
            } catch (e) {
                log(`Signature failed: ${e.message}`, 'error');

                if (btn) {
                    btn.disabled = false;
                    btn.innerText = 'Generate Signing Link';
                }

                alert('Signature Error: ' + e.message);
            }
        }
    </script>

    <script>
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'DOCUSIGN_SIGNED') {
                const statusEl = document.getElementById('contractStatus');
                if (statusEl) {
                    statusEl.innerText = 'SIGNED';
                    statusEl.style.color = 'green';
                }

                const signBtn = document.querySelector(
                    'button[onclick="sendForSignature()"]'
                );

                if (signBtn) {
                    signBtn.disabled = true;
                    signBtn.innerText = 'Signed ✔️';
                    signBtn.style.background = '#6c757d';
                }

                alert('✅ Document signed successfully!');
            }
        });
    </script>
</body>

</html>